function dump(a){if(a==null)return"null\n";if(a instanceof String)return a;var b="";for(var c in a)b+=c+": "+a[c]+"\n";return b}function ajaxError(a,b){return function(c,d,e){alert(a+"\ndata:\n"+dump(b)+"\nrequest:\n"+dump(d)+"\nsettings:\n"+dump(e))}}function showSnippet(a){var b=a.data("snippet-num");if(snippets.length>b){"left"in snippets[b]&&formatInto($("#left"),snippets[b].left),"right"in snippets[b]&&formatInto($("#right"),snippets[b].right),a.data("selected")!==undefined&&$(".selection .radio [value='"+a.data("selected")+"']").parent().trigger("click");var c=a.data("time");a.data("time",(new Date).getTime()-c),window.scrollTo(0,0)}else{a.data("time",0);var d={snippetnum:b};session!=null&&(d.session=""+session),formatInto($("#left"),"... retrieving snippet ..."),formatInto($("#right"),"... retrieving snippet ..."),radio_deselect(),$.ajax({url:"survey.py",type:"post",dataType:"json",data:d}).success(function(c){if(c.error){alert(c.error);return}"left"in c&&"right"in c&&(snippets[b]=c,c.session&&(session=c.session)),showSnippet(a)}).error(ajaxError("Error retrieving snippet "+(b+1),0))}}function addRow(){if(snippets.length>=total){var a={exp1:"complete"};$.ajax({url:"survey.py",type:"post",dataType:"json",data:a}).success(function(a){if(a.error){alert(a.error);return}$("body").html(a.body),window.scrollTo(0,0)}).error(function(a,b,c){alert("Error submitting survey.\nrequest:\n"+dump(b)+"\nsettings:\n"+dump(c))});return}var b=snippets.length,c="<h3><a href='#'>Snippet Pair "+(b+1)+" of "+total+"</a>"+"</h3>"+"<div>"+"<span class='preference'></span><br/>"+"<input type='submit' value='Submit' />"+"<span class='submitmsg' visible='false'>Submitting score, please be patient...</span>"+"<span class='newmsg' visible='true'>Please select which snippet is more readable.</span>"+"</div>";$("#history").prepend(c).accordion("destroy").accordion({autoHeight:!1,change:changeSnippets}),c=$("#history h3").first().next(),c.data("snippet-num",b),c.find("input[type=submit]").click(function(){if($(".selection .radio-select").length!=1)alert("Please rate this snippet before moving on.");else{var a=$(".selection input[type=radio]:checked").val();if(a!==undefined){var b=$(this);b.data("pending",!1).hide(),b.siblings(".submitmsg").show();var d=(new Date).getTime()-c.data("time"),e={session:session,snippetnum:c.data("snippet-num"),score:a,time:d};$.ajax({url:"survey.py",type:"post",dataType:"json",data:e}).success(function(a){b.siblings(".submitmsg").hide();if(a.error){alert("could not submit\n"+a.error);return}c.data("time",d),c.data("snippet-num")==snippets.length-1?addRow():$("#history").accordion("activate",0)}).error(ajaxError("Error submitting response:"),e)}else alert("could not determine score")}}).hide().siblings(".submitmsg").hide(),current_snippet=c,showSnippet(c)}function radio_deselect(){$(".selection .radio-select").removeClass("radio-select").addClass("radio").css("background-color",colors.regular_off).children("input[type=radio]").each(function(a){$(this).prop("checked",!1)})}function radio_select(){radio_deselect(),$(this).removeClass("radio").addClass("radio-select"),$(this).css("background-color")==colors.select_on||$(this).css("background-color")==colors.regular_on?$(this).css("background-color",colors.select_on):$(this).css("background-color",colors.select_off);var a=$(this).children("input[type=radio]");a.prop("checked",!0);var b=current_snippet.data("selected");if(b===undefined||b!=a.attr("value"))current_snippet.data("selected",a.attr("value")),current_snippet.children("input[type=submit]").data("pending",!0).show();formatInto(current_snippet.children(".preference").first(),"Snippet "+a.attr("value")),current_snippet.children(".newmsg").hide()}function changeSnippets(a,b){if(b.oldContent.find("input[type=submit]").data("pending")){var c=snippets.length-b.oldContent.data("snippet-num")-1;$("#history").accordion("activate",c),alert("Please submit your changes before leaving this snippet")}else{var d=(new Date).getTime()-b.oldContent.data("time");b.oldContent.data("time",d),radio_deselect(),current_snippet=b.newContent,showSnippet(b.newContent)}}function init(){$(".radio").hover(function(){$(this).hasClass("radio-select")?$(this).css("background-color",colors.select_on):$(this).css("background-color",colors.regular_on)},function(){$(this).hasClass("radio-select")?$(this).css("background-color",colors.select_off):$(this).css("background-color",colors.regular_off)}).click(radio_select),addRow()}var session=null,colors={regular_on:"#eeeeee",regular_off:"#ffffff",select_on:"#ff9640",select_off:"#ffb273"},total=25,snippets=[],current_snippet,formatInto;jQuery.browser.msie?formatInto=function(a,b){a.html(""),lines=b.replace(/\r/g,"").split("\n");for(i=0;i<lines.length;++i)a.append(lines[i]),a.append("\r")}:formatInto=function(a,b){a.html(b)};